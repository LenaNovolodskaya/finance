<!DOCTYPE html>
<html lang="en" 
      xmlns = "http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
    
    <head>
        <meta charset="UTF-8">
        <title>Операции</title>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link th:href="@{/css/style.css}" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    </head>
    
    <body>
        <div th:replace="~{header :: header}"></div>

        <div class="container mt-4">
            <h1>Список операций</h1>
            
            <div class="d-flex align-items-center mb-4" style="max-width: 1200px;">
                <a href="/transaction/transactionAdd" class="btn btn-primary me-3" style="min-width: 250px;">
                    <i class="fas fa-plus me-1"></i> Добавить операцию
                </a>

                <div class="flex-grow-1 ms-3">
                    <div class="d-flex justify-content-between p-3 rounded card-transaction">
                        <div class="me-4">
                            <strong>Доходы:
                                <span class="text-success" th:text="'+' + ${#numbers.formatDecimal(incomeSum, 1, 2)}">0.00</span>
                            </strong>
                        </div>
                        <div class="me-4">
                            <strong>Расходы:
                                <span class="text-danger" th:text="'-' + ${#numbers.formatDecimal(expenseSum, 1, 2)}">0.00</span>
                            </strong>
                        </div>
                        <div>
                            <strong>Баланс:
                                <span th:class="${balance >= 0} ? 'text-success' : 'text-danger'"
                                    th:text="${#numbers.formatDecimal(balance, 1, 2)}">0.00</span>
                            </strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Фильтры</h5>
                </div>
                <div class="card-body-filt">
                    <form th:action="@{/transaction/transactionList}" method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Начало периода</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" th:value="${startDate}">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">Конец периода</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" th:value="${endDate}">
                        </div>
                        <div class="col-md-3">
                            <label for="type" class="form-label">Тип операции</label>
                            <select class="form-select" id="type" name="type">
                                <option value="">Все</option>
                                <option th:each="type : ${types}" 
                                        th:value="${type.name()}"
                                        th:text="${type.displayName}"
                                        th:selected="${selectedType?.name() == type.name()}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categoryId" class="form-label">Категория</label>
                            <select class="form-select" id="categoryId" name="categoryId">
                                <option value="">Все</option>
                                <option th:each="category : ${categories}" 
                                        th:value="${category.id}" 
                                        th:text="${category.name}"
                                        th:selected="${selectedCategoryId == category.id}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-12 mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeDebts" name="excludeDebts" th:checked="${excludeDebts}">
                                <label class="form-check-label" for="excludeDebts">
                                    Не учитывать долги
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeGoals" name="excludeGoals" th:checked="${excludeGoals}">
                                <label class="form-check-label" for="excludeGoals">
                                    Не учитывать финансовые цели
                                </label>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">Применить</button>
                            <a th:href="@{/transaction/transactionList}" class="btn btn-secondary">Сбросить</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Тип</th>
                                    <th>Сумма</th>
                                    <th>Категория</th>
                                    <th>Дата</th>
                                    <th>Комментарий</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="transaction : ${transactions}">
                                    <td class="transaction-sign"
                                        th:classappend="${transaction.type.name() == 'INCOME'} ? 'income' : 'expense'"
                                        th:text="${transaction.type.name() == 'INCOME'} ? '+' : '-'">
                                    </td>
                                    <td th:text="${transaction.type.displayName}">Тип</td>
                                    <td th:text="${transaction.amount}">Сумма</td>
                                    <td th:text="${transaction.category.name}">Категория</td>
                                    <td th:text="${transaction.date}">Дата</td>
                                    <td th:text="${transaction.comment}">Комментарий</td>
                                    <td class="transaction-sign">
                                        <a th:href="@{/transaction/transactionEdit/{id}(id=${transaction.id})}"
                                           class="btn btn-sm btn-outline-primary"
                                           title="Редактировать операцию">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                    <td class="transaction-sign">
                                        <a th:href="@{/transaction/transactionDelete/{id}(id=${transaction.id})}"
                                           class="btn btn-sm btn-outline-danger"
                                           title="Удалить операцию"
                                           onclick="return confirm('Вы уверены, что хотите удалить эту запись?')">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                if (startDateInput && endDateInput && (!startDateInput.value || !endDateInput.value)) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = today.getMonth();

                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);

                    const formatDate = (date) => {
                        const d = new Date(date);
                        let monthStr = '' + (d.getMonth() + 1);
                        let dayStr = '' + d.getDate();
                        const yearStr = d.getFullYear();

                        if (monthStr.length < 2) monthStr = '0' + monthStr;
                        if (dayStr.length < 2) dayStr = '0' + dayStr;

                        return [yearStr, monthStr, dayStr].join('-');
                    };

                    if (!startDateInput.value) {
                         startDateInput.value = formatDate(firstDay);
                    }
                    if (!endDateInput.value) {
                        endDateInput.value = formatDate(lastDay);
                    }
                }
            });
        </script>
    </body>
</html>